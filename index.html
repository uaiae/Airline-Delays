<!DOCTYPE html>
<html>

<head>

  <title> Airline On-Time Statistics</title>
  
  <meta charset="utf-8">
  <meta name="author" content = "Michael Dugas">
    
  <style>
  <!-- Kommentar im HTML-Quelltext -->
  
  h1 {
    text-align: left;
    color: black;
    font: 16px sans-serif;
  }

  h2 {
    text-align: left;
    color: black;
    font: 14px sans-serif;
  }

  p {
    text-align: left;
    color: grey;
    font: 12px sans-serif;
  }
  
  .axis {
    font-family: arial;
    font-size: 0.6em;
  }

  .axis path{
    fill: none;
    stroke: black;
  }
  
  .axis line  {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  text.explanations {
    font: 12px sans-serif;
  }
  
  
  div.next_buttons {
        position: fixed;
        top: 180px;
        left: 30px;
        font: 14px sans-serif;
      }

  div.next_buttons div {
        background-color: "grey";
        padding: 3px;
        margin: 7px;
      }
  
  div.tooltip {
    position: absolute;
    text-align: left;
    width: 280px;
    height: 64px;
    padding: 1px;
    font: 10px sans-serif;
    background: white;
    border: 0px;
    border-radius: 2px;
    pointer-events: none;
  }
  
  </style>
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
  
  <script type="text/javascript">
  function draw(date, data) {
  "use strict"; // instructs browser to apply strict interpretation of Java Scrip rules.
  
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// Variables
  var margin = 125,
      width = 1400-margin,
      height = 600-margin;
  
  var time_extent = d3.extent(data, function(d) {
              return d['date'];
  });
  
  var y_extent = d3.extent(data, function(d){
    return d['average_delay'];
  });
                    
  var x_scale = d3.time.scale()
                  .domain(time_extent)
                  .range([margin,width]);

  var y_scale = d3.scale
                  .linear()
                  .range([height, margin])
                  .domain(y_extent);
                  
  
  var x_axis = d3.svg.axis()
                     .scale(x_scale)
                     .ticks(14)
                     .orient("bottom");
  
  var y_axis = d3.svg.axis()
                     .scale(y_scale)
                     .ticks(5)
                     .orient("left");
                     
  var formatTime = d3.time.format("%B %Y");
  
  // line generator
  var line = d3.svg.line()
               .x(function(d) { return x_scale(d.date); })
               .y(function(d) { return y_scale(d.average_delay); });
  
  // Define the div for the tooltip
  var div = d3.select("body")
              .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
  
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Additional functions
  
  
  var major_airports = ["ATL", "BWI", "BOS", "CLT", "MDW", "ORD", "DAL", "DFW", "DEN", "DTW", "FLL", "IAH", "LAS", "LAX", "MIA", "MSP", "JFK", "LGA", "EWR", "MCO", "PHL", "PHX", "PDX", "SLC", "SAN", "SFO", "SEA", "TPA", "DCA", "IAD"]
  
  // 
  
  
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Static Text Blocks
  d3.select("body")
    .append("h1")
    .text("Airline On-Time Statistics 2003-2017")
    .append("h2")
    .text("Reference: Bureau of Transport Statistics")
    .append("h6")
    .text("Last Update: 2017-09-18 by M. Dugas")

  // Variable Text Blocks
  
  d3.select("svg")
    .append("button")
 
  //buttons
  
  
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Shaping the svg elements
  // SVG is an XML based specification for drawing things.
  // All SVG elements live inside an svg tag.
  var svg = d3.select("body")
              .append("svg")
                .attr("width", width + margin)
                .attr("height", height + margin)
              .append("g")
                .attr("class", "chart");
                
  var airline = "UA"
  
//  d3.select("svg")
   
  svg.selectAll("circle")
    .data(data)
    .enter()
    .append("circle")
//    .filter(function(d) {return d.carrier == "AA"})
      .style("fill", function(d) {
        if (d.carrier == airline) {return "red"}
        else {return "black"};
      })
    .style("opacity", function(d) {
        if (d.carrier == airline) {return 0.8}
        else {return 0.2};
      })
      .attr("r", function(d) {
        if (d.carrier == airline) {return 2}
        else {return 1};
      })
      .attr("cx", function(d) {return x_scale(d.date)})
      .attr("cy", function(d) {return y_scale(d.average_delay)})
      .on("mouseover", function(d){
        d3.select(this).attr("r", 4).style("fill", "red");
        div.transition()
           .duration(200)
           .style("opacity", .95)
        div.html(d.carrier_name + "<br/>" + d.airport_name + "<br/>" + formatTime(d.date) + "<br/>" + "average delay [min/flight] " + d.average_delay_round + "<br/>" + "flights [-] " + d.arr_flights + "<br/>" + "delay [min] " + d.arr_delay)
           .style("left", (d3.event.pageX+5) + "px")
           .style("top", (d3.event.pageY-64) + "px");
        })
       .on("mouseout", function(d){
         d3.select(this).attr("r", 2).style("fill", "grey");
         div.transition()
            .duration(500)
            .style("opacity", 0);
       });
// Place and scale axes

   d3.select("svg")
    .append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
    .call(x_axis)

  d3.select(".x.axis")
    .append("text")
      .text("Year")
      .attr("x", width/2)
      .attr("y", margin/2);
 
  d3.select("svg")
    .append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(" + margin + ", 0)")
    .call(y_axis)
    
  d3.select(".y.axis")    
    .append("text")
      .text("Average delay per flight measured in minutes")
      .attr("x", 10)
      .attr("y", margin);

// Explanatory Text
 
   var explanations = ["Based on the data compiled by the Bureau of Transport Statistics in the years 2003 to 2017 the average delay in minutes per flight has been derived." ,
                       "The data covers 365 reportable American airports and 12 reporting airlines."]
   
   d3.select("svg")
     .append("text")
       .text("Selected airline : " + airline)
       .attr("x", 1000)
       .attr("y", 150)
       
   d3.select("svg")
     .append("text")
       .text(explanations[0])
       .attr("x", margin)
       .attr("y", margin/2)

   d3.select("svg")
     .append("text")
       .text(explanations[1])
       .attr("x", margin)
       .attr("y", margin/2 + 16)   
    
  function update(steps) {
   svg.selectAll("circle")
      .data(data)
      .enter()
      .append("circle")
      .attr("fill", "blue")
      }
//      .attr("fill", function(d) {
//        if (steps == "Step 2") {return "blue";}
//        else {return "black";};
//      }
  
    
// Buttons
   
   var steps = ["Step 1", "Step 2", "Step 3"];
   
   var buttons = d3.select("body")
                   .append("div")
                   .attr("class", "next_buttons")
                   .selectAll("div")
                   .data(steps)
                   .enter()
                   .append("div")
                   .attr("width", 100)
                   .text(function(d) {
                          return d;
                    });

   
   buttons.on("click", function(d) {
              d3.select(".next_buttons")
                      .selectAll("div")
                      .transition()
                      .duration(100)
                      .style("color", "black")
                      .style("background", "grey");

                    d3.select(this)
                      .transition()
                      .duration(100)
                      .style("background", "lightBlue")
                      .style("color", "white");
                    update(d);                     
                });

  
  }




  
  </script>
  
</head>

<body>

  <script type="text/javascript">
  
  formattime = d3.time.format("%Y-%m");
  
  formatround = d3.format(".1f");
  
  d3.csv("973767840_62017_2345_airline_delay_causes.csv", function(d){
    d['date'] = formattime.parse(d['year'] + "-" + d['month']);
    d['arr_flights'] = +d['arr_flights'];
    d['arr_delay'] = +d['arr_delay'];
    d['average_delay'] = d['arr_delay'] / d['arr_flights'];
    d['average_delay_round'] = formatround(+d['average_delay'] || 0);// convert NaNs into zeros and round to one digit
    d['average_delay'] = +d['average_delay'] || 0;// convert NaNs into zeros and round to one digit
    return d
  }, draw)
    
  // Parameter Summary
  // ---------------------------------------------------------------------------------------------------------------------------------------------------------
  // | Parameter Name       | Example Value                                   | Description                                                                  |
  // | year                 | 2017                                            | year of observation                                                          |
  // | month                | 6                                               | month of oberservation                                                       |
  // | carrier              | WN                                              | airline IATA code                                                            |
  // | carrier_name         | Southwest Airlines Co."                         | airline full name                                                            |
  // | airport              | MKE"                                            | airport IATA code                                                            |
  // | airport_name         | Milwaukee, WI: General Mitchell International   | full airport name                                                            |
  // | arr_flights          | 1064.00                                         | total number of operations, of that airline in the given period              |
  // | arr_del15            | 268.00                                          | number of arrival delayed 15min                                              |
  // | carrier_ct           | 85.33                                           | number of arrivals delayed due to carrier                                    |
  // | weather_ct           | 6.52                                            | number of arrivals delayed due to weather                                    |
  // | nas_ct               | 28.96                                           | number of arrivals delayed to due national aviatoin system                   |
  // | security_ct          | 0.67                                            | number of arrivals delayed due to security reasons                           |
  // | late_aircraft_ct     | 146.52                                          | number of aircraft arriving late                                             |
  // | arr_cancelled        | 8.00                                            | number of cancelled arrivals                                                 |
  // | arr_diverted         | 0.00                                            | number of diverted arrivals                                                  |
  // | arr_delay            | 17353.00                                        | Total delayed minutes (sum of carrier, weather, nas, security, late_aircraft)|
  // | carrier_delay        | 4711.00                                         | delayed minutes due to carrier                                               |
  // | weather_delay        | 1223.00                                         | delayed minutes due to weather                                               |
  // | nas_delay            | 1196.00                                         | delayed minutes due to national aviation system                              |
  // | security_delay       | 94.00                                           | delayed minutes due to security                                              |
  // | late_aircraft_delay  | 10129.00                                        | delayed minutes due to aircraft arriving late                                |
  
  </script>
  
</body>
</html>
